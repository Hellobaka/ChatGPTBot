<Page
    x:Class="me.cqp.luohuaming.ChatGPT.UI.Pages.Settings"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:me.cqp.luohuaming.ChatGPT.UI"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.modernwpf.com/2019"
    d:Height="700"
    d:Width="1200"
    Loaded="Page_Loaded"
    mc:Ignorable="d">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>
        <TabControl>
            <TabItem Header="API设置">
                <ScrollViewer>
                    <StackPanel x:Name="APIContainer" Margin="16,16,22,16">
                        <TextBlock VerticalAlignment="Center">API 令牌:</TextBlock>
                        <TextBox x:Name="APIKey" Margin="0,5,0,0" />
                        <StackPanel Margin="0,5,0,0" Orientation="Horizontal">
                            <TextBlock>API URL:</TextBlock>
                            <TextBlock Margin="5,0,0,0" FontWeight="Bold">https://api.openai.com/v1</TextBlock>
                            <TextBlock>/chat/completions</TextBlock>
                        </StackPanel>
                        <TextBox x:Name="BaseURL" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">对话模型名称:</TextBlock>
                        <TextBox x:Name="ModelName" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">对话最大Token:</TextBlock>
                        <TextBox x:Name="ChatMaxTokens" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">绘图画布尺寸:</TextBlock>
                        <ComboBox x:Name="ImageGenerateSize" Margin="0,5,0,0">
                            <ComboBoxItem
                                Content="256x256"
                                IsSelected="True"
                                Tag="0" />
                            <ComboBoxItem Content="512x512" Tag="1" />
                            <ComboBoxItem Content="1024x1024" Tag="2" />
                            <ComboBoxItem Content="1024x1792" Tag="3" />
                            <ComboBoxItem Content="1792x1024" Tag="4" />
                        </ComboBox>
                        <TextBlock VerticalAlignment="Center">绘图质量:</TextBlock>
                        <ComboBox x:Name="ImageGenerateQuality" Margin="0,5,0,0">
                            <ComboBoxItem
                                Content="Standard"
                                IsSelected="True"
                                Tag="0" />
                            <ComboBoxItem Content="High" Tag="1" />
                        </ComboBox>
                        <StackPanel VerticalAlignment="Center" Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">移除思维链输出:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="RemoveThinkBlock"
                                Margin="10,0,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">流式输出:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="StreamMode"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">启用视觉输入:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="EnableVision"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <TextBlock VerticalAlignment="Center">Bot 名称:</TextBlock>
                        <TextBox x:Name="BotName" Margin="0,5,0,0" />
                        <TextBlock Margin="0,10,0,0">私聊使用的默认 Prompt:</TextBlock>
                        <TextBox
                            x:Name="PrivatePrompt"
                            Margin="0,5,0,0"
                            AcceptsReturn="True"
                            TextWrapping="Wrap" />
                        <TextBlock VerticalAlignment="Center">群组使用的默认 Prompt:</TextBlock>
                        <TextBox
                            x:Name="GroupPrompt"
                            Margin="0,5,0,0"
                            TextWrapping="Wrap" />
                        <TextBlock VerticalAlignment="Center">Prompt 文本模板支持的变量 (点击可复制)：</TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="$ModelName$">
                            $ModelName$    当前使用的模型名称
                        </TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="$Time$">
                            $Time$    当前时间
                        </TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="$BotName$">
                            $BotName$    机器人昵称
                        </TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="$Id$">
                            $Id$    调用者ID
                        </TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="$GroupName$">
                            $GroupName$    群组名称
                        </TextBlock>
                        <TextBlock
                            Margin="10,5,0,0"
                            Cursor="Hand"
                            MouseDown="TextTemplate_MouseDown"
                            Tag="&lt;@QQ&gt;"
                            Text="&lt;@QQ&gt;    转换为At消息的模板" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <TabItem Header="指令设置">
                <ScrollViewer>
                    <StackPanel x:Name="CommandContainer" Margin="16,16,22,16">
                        <TextBlock VerticalAlignment="Center">对话:</TextBlock>
                        <TextBox x:Name="ResponsePrefix" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">触发聊天时发送的文本:</TextBlock>
                        <TextBox x:Name="WelcomeText" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">连续模式:</TextBlock>
                        <TextBox x:Name="ContinueModeOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">添加预设:</TextBlock>
                        <TextBox x:Name="AddPromptOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">移除预设:</TextBlock>
                        <TextBox x:Name="RemovePromptOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">预设列表:</TextBlock>
                        <TextBox x:Name="ListPromptOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">启用单群聊天:</TextBlock>
                        <TextBox x:Name="EnableChatOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">禁用单群聊天:</TextBlock>
                        <TextBox x:Name="DisableChatOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">重置对话上下文:</TextBlock>
                        <TextBox x:Name="ResetChatOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">使用预设进行对话:</TextBlock>
                        <TextBox x:Name="ChatPromptOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">绘图:</TextBlock>
                        <TextBox x:Name="ImageGenerationOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">添加黑名单:</TextBlock>
                        <TextBox x:Name="AddBlackListOrder" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">移除黑名单:</TextBlock>
                        <TextBox x:Name="RemoveBlackListOrder" Margin="0,5,0,0" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <TabItem Header="响应设置">
                <ScrollViewer>
                    <StackPanel x:Name="ResponseContainer" Margin="16,16,22,16">
                        <TextBlock VerticalAlignment="Center">会话保留时长 (秒):</TextBlock>
                        <TextBox x:Name="ChatTimeout" Margin="0,5,0,0" />
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">响应最后添加请求耗时 (秒):</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="AppendExecuteTime"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">使用回复模式发送消息:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="EnableGroupReply"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">回复消息 + @Bot 时触发聊天:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="ReplyResponse"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">@Bot 时触发聊天:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="AtResponse"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">@ 块可不在消息头:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="AtAnyPosition"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">每条消息附加发送者昵称 (配合 Prompt 使用):</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="AppendGroupNick"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">随机回复开关:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="RandomReply"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <TextBlock VerticalAlignment="Center">随机回复采样时长 (分钟):</TextBlock>
                        <TextBox x:Name="RandomReplyMinuteInterval" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">采样周期中群组最大对话数量:</TextBlock>
                        <TextBox x:Name="RandomReplyConversationCount" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">采样周期中私聊最大对话数量:</TextBlock>
                        <TextBox x:Name="RandomReplyPersonalConversationCount" Margin="0,5,0,0" />

                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">随机回复时启用分段功能:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="EnableSpliter"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <TextBlock VerticalAlignment="Center">分段使用的大模型名称:</TextBlock>
                        <TextBox x:Name="SpliterModelName" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">分段使用的 Prompt:</TextBlock>
                        <TextBox
                            x:Name="SpliterPrompt"
                            Height="60"
                            Margin="0,5,0,0"
                            TextWrapping="Wrap" />
                        <TextBlock VerticalAlignment="Center">最大分段数量:</TextBlock>
                        <TextBox x:Name="SpliterMaxLines" Margin="0,5,0,0" />
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">移除分段末尾句号:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="SpliterRegexRemovePunctuation"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">分段仅使用正则表达式（按标点符号分句）:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="SpliterRegexFirst"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">发送每个分段启用随机延时:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="EnableSpliterRandomDelay"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <TextBlock VerticalAlignment="Center">分段模拟打字速度（字符/分钟）:</TextBlock>
                        <TextBox x:Name="SpliterSimulateTypeSpeed" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">分段随机等待延时随机数下限（毫秒）:</TextBlock>
                        <TextBox x:Name="SpliterRandomDelayMin" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">分段随机等待延时随机数上限（毫秒）:</TextBlock>
                        <TextBox x:Name="SpliterRandomDelayMax" Margin="0,5,0,0" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <TabItem Header="群组设置">
                <ScrollViewer>
                    <StackPanel x:Name="GroupContainer" Margin="16,16,22,16">
                        <TextBlock VerticalAlignment="Center">管理员 QQ:</TextBlock>
                        <TextBox x:Name="MasterQQ" Margin="0,5,0,0" />
                        <TextBlock VerticalAlignment="Center">启用群列表:</TextBlock>
                        <ListBox
                            x:Name="GroupList"
                            MinHeight="20"
                            MaxHeight="150"
                            Margin="0,5,0,0" />
                        <Grid Margin="0,5,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Button
                                x:Name="GroupListRemoveButton"
                                Grid.Column="0"
                                Width="50"
                                Margin="0,0,10,0"
                                Click="GroupListRemoveButton_Click">
                                删除
                            </Button>
                            <TextBox x:Name="GroupListAdd" Grid.Column="1" />
                            <Button
                                x:Name="GroupListAddButton"
                                Grid.Column="2"
                                Width="50"
                                Margin="10,0,0,0"
                                Click="GroupListAddButton_Click">
                                添加
                            </Button>
                        </Grid>

                        <TextBlock VerticalAlignment="Center">启用私聊列表:</TextBlock>
                        <ListBox
                            x:Name="PersonList"
                            MinHeight="20"
                            MaxHeight="150"
                            Margin="0,5,0,0" />
                        <Grid Margin="0,5,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Button
                                x:Name="PersonListRemoveButton"
                                Grid.Column="0"
                                Width="50"
                                Margin="0,0,10,0"
                                Click="PersonListRemoveButton_Click">
                                删除
                            </Button>
                            <TextBox x:Name="PersonListAdd" Grid.Column="1" />
                            <Button
                                x:Name="PersonListAddButton"
                                Grid.Column="2"
                                Width="50"
                                Margin="10,0,0,0"
                                Click="PersonListAddButton_Click">
                                添加
                            </Button>
                        </Grid>
                        <TextBlock VerticalAlignment="Center">黑名单:</TextBlock>
                        <ListBox
                            x:Name="BlackList"
                            MinHeight="20"
                            MaxHeight="150"
                            Margin="0,5,0,0" />
                        <Grid Margin="0,5,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="auto" />
                            </Grid.ColumnDefinitions>
                            <Button
                                x:Name="BlackListRemoveButton"
                                Grid.Column="0"
                                Width="50"
                                Margin="0,0,10,0"
                                Click="BlackListRemoveButton_Click">
                                删除
                            </Button>
                            <TextBox x:Name="BlackListAdd" Grid.Column="1" />
                            <Button
                                x:Name="BlackListAddButton"
                                Grid.Column="2"
                                Width="50"
                                Margin="10,0,0,0"
                                Click="BlackListAddButton_Click">
                                添加
                            </Button>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <TabItem Header="TTS设置">
                <ScrollViewer>
                    <StackPanel x:Name="TTSContainer" Margin="16,16,22,16">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">TTS开关:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="EnableTTS"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">发送音频前发送文本:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="SendTextBeforeTTS"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock VerticalAlignment="Center">合成音频错误时发送提示文本:</TextBlock>
                            <ui:ToggleSwitch
                                x:Name="SendErrorTextWhenTTSFail"
                                Margin="10,5,0,0"
                                OffContent=""
                                OnContent="" />
                        </StackPanel>
                        <StackPanel Margin="0,5,0,0" Orientation="Horizontal">
                            <TextBlock>使用的音色名称:</TextBlock>
                            <TextBlock Margin="5,0,0,0">
                                <Hyperlink NavigateUri="https://github.com/rany2/edge-tts?tab=readme-ov-file#changing-the-voice" RequestNavigate="Hyperlink_RequestNavigate">获取音色列表</Hyperlink>
                            </TextBlock>
                        </StackPanel>
                        <TextBox x:Name="TTSVoice" Margin="0,5,0,0" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
        <Button
            x:Name="SaveButton"
            Grid.Row="1"
            Margin="16,5,16,16"
            HorizontalAlignment="Stretch"
            Click="SaveButton_Click"
            Style="{StaticResource AccentButtonStyle}">
            保存
        </Button>
    </Grid>
</Page>
